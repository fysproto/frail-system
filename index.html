<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* ç”»é¢å…¨ä½“ã®å›ºå®š */
        html, body { 
            position: fixed; width: 100%; height: 100%; 
            overflow: hidden; touch-action: none; 
            font-family: sans-serif; margin: 0; background: #f0f4f8; 
        }
        #app { display: flex; flex-direction: column; height: 100%; }
        header { height: 70px; background: #fff; text-align: center; border-bottom: 2px solid #dee2e6; display: flex; flex-direction: column; justify-content: center; }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ï¼šé«˜ã•ã‚’å›ºå®š */
        #main-stage { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        
        /* å›ç­”ã‚¨ãƒªã‚¢ï¼šå¸¸ã«åŒã˜å ´æ‰€ã«é…ç½® */
        #drop-zone { width: 150px; height: 150px; border: 4px dashed #adb5bd; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #fff; position: relative; color: #adb5bd; font-size: 0.8rem; }
        .placed-seal { width: 100%; height: 100%; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; position: absolute; animation: pop 0.2s; }
        
        /* é¸æŠè‚¢ã‚¨ãƒªã‚¢ï¼šé«˜ã•ã‚’180pxã«å›ºå®šã—ã¦ç”»é¢ã®æºã‚Œã‚’é˜²ã */
        #seals-container { height: 180px; background: #fff; border-top: 1px solid #dee2e6; display: flex; flex-direction: column; justify-content: center; gap: 10px; padding: 10px 0; }
        .seal-row { display: flex; gap: 12px; justify-content: center; width: 100%; }
        .seal { width: 68px; height: 68px; border-radius: 50%; background: #e9ecef; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }

        /* è¨ˆæ¸¬å…¥åŠ›ç”»é¢ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        #input-form { display: none; width: 90%; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .input-group { margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; }
        .input-group input { width: 80px; padding: 8px; font-size: 1.2rem; border: 1px solid #ddd; border-radius: 5px; text-align: right; }
        .status-dot { width: 25px; height: 25px; border-radius: 50%; background: #ddd; }

        .bg-blue { background: #007bff !important; } .bg-red { background: #dc3545 !important; } .bg-yellow { background: #ffc107 !important; color: #000; }
        #next-btn { display: none; margin-top: 15px; padding: 10px 40px; border-radius: 25px; border: none; background: #28a745; color: white; font-weight: bold; }
        @keyframes pop { 0% { transform: scale(0.6); } 100% { transform: scale(1); } }
    </style>
</head>
<body ontouchmove="event.preventDefault()">
<div id="app">
    <header>
        <div id="q-progress" style="font-size: 0.7rem; color: #6c757d;"></div>
        <div id="q-text" style="font-weight: bold; font-size: 0.9rem; padding: 0 10px;"></div>
    </header>

    <div id="main-stage">
        <div id="drop-zone-wrap">
            <div id="drop-zone">ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—</div>
        </div>

        <div id="input-form">
            <div class="input-group">
                <span>æ¡åŠ› (kg)</span>
                <input type="number" id="grip" placeholder="0.0" oninput="judgeGrip()">
                <div id="dot-grip" class="status-dot"></div>
            </div>
            <div class="input-group">
                <span>èº«é•· (cm)</span>
                <input type="number" id="height" placeholder="0.0" oninput="calcBMI()">
                <div></div>
            </div>
            <div class="input-group">
                <span>ä½“é‡ (kg)</span>
                <input type="number" id="weight" placeholder="0.0" oninput="calcBMI()">
                <div></div>
            </div>
            <div class="input-group" style="border-top: 1px solid #eee; padding-top: 10px;">
                <span>BMI</span>
                <span id="bmi-val" style="font-weight: bold; font-size: 1.2rem;">--</span>
                <div id="dot-bmi" class="status-dot"></div>
            </div>
        </div>

        <button id="next-btn" onclick="goNext()">æ¬¡ã¸é€²ã‚€</button>
    </div>

    <div id="seals-container"></div>
</div>

<script>
    const questions = [
        { id: 12, text: "Q12. åœ°åŸŸæ´»å‹•ã«å‚åŠ ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ", opts: ["é€±1ä»¥ä¸Š", "æœˆ1ä»¥ä¸Š", "å¹´æ•°å›", "ä»¥å‰ã¯å‚åŠ ", "å‚åŠ ã›ãš"], type: "neutral" },
        { id: 7, text: "Q7. æ­©ãé€Ÿåº¦ãŒé…ããªã‚Šã¾ã—ãŸã‹ï¼Ÿ", opts: ["ã¯ã„", "ã„ã„ãˆ"], type: "logic", red: "ã¯ã„", blue: "ã„ã„ãˆ" },
        { id: "calc", text: "èº«ä½“è¨ˆæ¸¬ï¼ˆæ¡åŠ›ãƒ»BMIï¼‰", type: "calc" }
    ];

let currentIdx = 0;
let currentIdx = 0;
    let allAnswers = {};

    const questions = [
        { id: "q1_community", title: "åœ°åŸŸæ´»å‹•ã«å‚åŠ ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ", item: "ğŸ ", color: "bg-blue" },
        { id: "q2_walking", title: "æœ€è¿‘ã€æ­©ãã®ãŒé…ããªã£ãŸï¼Ÿ", item: "ğŸš¶", color: "bg-green" },
        { id: "q3_measurement", title: "æ¡åŠ›ã¨BMIã‚’æ¸¬å®šã—ã‚ˆã†", item: "âš–ï¸", color: "bg-orange" }
    ];

    function load() {
        const q = questions[currentIdx];
        document.getElementById('q-title').innerText = q.title;
        document.getElementById('step-info').innerText = `Step ${currentIdx + 1} / ${questions.length}`;
        
        const stage = document.getElementById('main-stage');
        // ã“ã“ã§ç”»é¢ã‚’çµ„ã¿ç«‹ã¦ã‚‹ã‚
        stage.innerHTML = `
            <div id="drop-zone">ã‚³ã‚³ã«é‹ã‚“ã§</div>
            <div id="item-box">
                <div class="active-item ${q.color}" id="active-item" 
                     ontouchstart="onStart(event)" onmousedown="onStart(event)"
                     style="position: static;">${q.item}</div>
            </div>
            ${q.id === 'q3_measurement' ? `
                <div id="input-grip" class="input-card">
                    <div class="status-dot" id="dot-grip"></div>
                    æ¡åŠ›(kg): <input type="number" id="grip" step="0.1" oninput="judgeGrip()">
                </div>
                <div id="input-bmi" class="input-card">
                    <div class="status-dot" id="dot-bmi"></div>
                    èº«é•·(cm): <input type="number" id="height" step="0.1" oninput="calcBMI()"><br>
                    ä½“é‡(kg): <input type="number" id="weight" step="0.1" oninput="calcBMI()">
                    <div style="margin-top:5px; font-weight:bold;">BMI: <span id="bmi-val">--</span></div>
                </div>
            ` : ''}
            <button id="next-btn" onclick="goNext()" style="display:none;">æ¬¡ã¸é€²ã‚€</button>
        `;
    }

    // â˜…å¤§äº‹ï¼šæœ€åˆã«ã“ã®é–¢æ•°ã‚’å‘¼ã°ãªã„ã¨ç”»é¢ãŒçœŸã£ç™½ã«ãªã‚‹ã‚ï¼
    load();

    function goNext() {
        const currentQ = questions[currentIdx];
        const inputs = document.querySelectorAll('#main-stage input');
        inputs.forEach(input => {
            allAnswers[input.id] = input.value;
        });
        const bmiVal = document.getElementById('bmi-val');
        if (bmiVal) allAnswers['bmi'] = bmiVal.innerText;

        const isDropped = document.getElementById('drop-zone').querySelector('.active-item');
        allAnswers[currentQ.id] = isDropped ? "ã¯ã„" : "ã„ã„ãˆ";

        currentIdx++;
        if (currentIdx < questions.length) {
            load();
        } else {
            const url = new URL(window.location.href);
            Object.keys(allAnswers).forEach(key => {
                url.searchParams.set(key, allAnswers[key]);
            });
            window.location.href = url.href; 
        }
    }

    let active, isDragging = false;
    function onStart(e) {
        isDragging = true;
        active = e.target;
        active.style.position = "absolute"; // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚ã«çµ¶å¯¾é…ç½®ã«åˆ‡ã‚Šæ›¿ãˆ
        const t = e.touches ? e.touches[0] : e;
        updatePos(t);
        
        document.onmousemove = document.ontouchmove = (ev) => {
            if(!isDragging) return;
            const tt = ev.touches ? ev.touches[0] : ev;
            updatePos(tt);
        };
        
        document.onmouseup = document.ontouchend = () => {
            if(!isDragging) return;
            isDragging = false;
            const dz = document.getElementById('drop-zone').getBoundingClientRect();
            const it = active.getBoundingClientRect();
            
            // åˆ¤å®šï¼šãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã«å…¥ã£ãŸã‹
            if (it.left > dz.left && it.right < dz.right && it.top > dz.top && it.bottom < dz.bottom) {
                document.getElementById('drop-zone').innerText = ""; // æ–‡å­—ã‚’æ¶ˆã™
                document.getElementById('drop-zone').appendChild(active);
                active.style.position = "static";
                document.getElementById('next-btn').style.display = "block";
            }
            document.onmousemove = document.ontouchmove = null;
        };
    }

    function updatePos(t) { 
        if(!active) return;
        active.style.left = (t.clientX - 34) + 'px'; 
        active.style.top = (t.clientY - 34) + 'px'; 
    }

    function judgeGrip() {
        const val = parseFloat(document.getElementById('grip').value);
        const dot = document.getElementById('dot-grip');
        if (dot) dot.className = "status-dot " + (val < 28 ? "bg-red" : "bg-blue");
    }

    function calcBMI() {
        const h = parseFloat(document.getElementById('height').value) / 100;
        const w = parseFloat(document.getElementById('weight').value);
        const bmiVal = document.getElementById('bmi-val');
        const dot = document.getElementById('dot-bmi');
        if (h > 0 && w > 0 && bmiVal) {
            const bmi = (w / (h * h)).toFixed(1);
            bmiVal.innerText = bmi;
            if(dot) dot.className = "status-dot " + (bmi < 21.5 ? "bg-red" : "bg-blue");
        }
    }