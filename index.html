<script>
    // ... (questions, load, renderSeals, onStart, judgeGrip, calcBMI などは全く同じ) ...

    function goNext() {
        if (currentIdx === questions.length - 1) {
            allAnswers.grip = document.getElementById('grip').value;
            allAnswers.bmi = document.getElementById('bmi-val').innerText;
            allAnswers.is_done = true;

            // ★ ここが修正の核心：postMessageをやめて、親画面のURLを書き換える
            const payload = encodeURIComponent(JSON.stringify(allAnswers));
            const baseUrl = window.top.location.origin + window.top.location.pathname;
            
            // 親（Streamlit）にデータを投げつつリロードさせる
            window.top.location.href = baseUrl + "?done=1&data=" + payload;

        } else {
            currentIdx++; load();
        }
    }
    load();
</script>
</body>
</html>