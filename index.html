<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒ•ãƒ¬ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯ãƒ»ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—</title>
    <style>
        html, body { 
            position: fixed; width: 100%; height: 100%; 
            overflow: hidden; touch-action: none; 
            font-family: sans-serif; margin: 0; background: #f0f4f8; 
        }
        #app { display: flex; flex-direction: column; height: 100%; }
        header { height: 80px; background: #fff; text-align: center; border-bottom: 2px solid #dee2e6; display: flex; flex-direction: column; justify-content: center; }
        h2 { margin: 0; font-size: 18px; color: #333; }
        #step-info { font-size: 12px; color: #888; margin-top: 4px; }
        
        #main-stage { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        
        #drop-zone { width: 160px; height: 160px; border: 4px dashed #adb5bd; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #fff; color: #adb5bd; margin-bottom: 30px; font-weight: bold; transition: all 0.3s; }
        #drop-zone.active { border-color: #007bff; background: #e7f1ff; }

        #item-box { height: 100px; display: flex; align-items: center; justify-content: center; width: 100%; }
        .active-item { width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; color: #fff; cursor: pointer; user-select: none; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        .bg-blue { background: #007bff; }
        .bg-green { background: #28a745; }
        .bg-orange { background: #fd7e14; }
        .bg-red { background: #dc3545; }

        .input-card { background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 10px; width: 85%; max-width: 300px; }
        input[type="number"] { width: 60px; padding: 8px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; margin: 5px; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; background: #ccc; }

        #next-btn { display: none; margin-top: 25px; padding: 12px 40px; font-size: 18px; font-weight: bold; border-radius: 25px; background: #007bff; color: white; border: none; box-shadow: 0 4px 12px rgba(0,123,255,0.3); }
    </style>
</head>
<body>

<div id="app">
    <header>
        <h2 id="q-title">èª­ã¿è¾¼ã¿ä¸­...</h2>
        <div id="step-info">Step 1 / 3</div>
    </header>
    <div id="main-stage">
        </div>
</div>

<script>
    let currentIdx = 0;
    let allAnswers = {};

    // â˜…æœ¬ç•ªã§15å•ã«ã™ã‚‹æ™‚ã¯ã“ã®é…åˆ—ã‚’å¢—ã‚„ã™ã ã‘ï¼
    const questions = [
        { id: "q1_community", title: "åœ°åŸŸæ´»å‹•ã«å‚åŠ ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ", item: "ğŸ ", color: "bg-blue" },
        { id: "q2_walking", title: "æœ€è¿‘ã€æ­©ãã®ãŒé…ããªã£ãŸï¼Ÿ", item: "ğŸš¶", color: "bg-green" },
        { id: "q3_measurement", title: "æ¡åŠ›ã¨BMIã‚’æ¸¬å®šã—ã‚ˆã†", item: "âš–ï¸", color: "bg-orange" }
    ];

    function load() {
        const q = questions[currentIdx];
        document.getElementById('q-title').innerText = q.title;
        document.getElementById('step-info').innerText = `Step ${currentIdx + 1} / ${questions.length}`;
        
        const stage = document.getElementById('main-stage');
        stage.innerHTML = `
            <div id="drop-zone">ã‚³ã‚³ã«é‹ã‚“ã§</div>
            <div id="item-box">
                <div class="active-item ${q.color}" id="active-item" 
                     ontouchstart="onStart(event)" onmousedown="onStart(event)">${q.item}</div>
            </div>
            ${q.id === 'q3_measurement' ? `
                <div class="input-card">
                    <div class="status-dot" id="dot-grip"></div>æ¡åŠ›: <input type="number" id="grip" step="0.1" oninput="judge()"> (kg)
                </div>
                <div class="input-card">
                    <div class="status-dot" id="dot-bmi"></div>
                    èº«é•·: <input type="number" id="height" step="0.1" oninput="judge()"> (cm)<br>
                    ä½“é‡: <input type="number" id="weight" step="0.1" oninput="judge()"> (kg)
                    <div style="margin-top:8px;">BMI: <span id="bmi-val" style="font-weight:bold;">--</span></div>
                </div>
            ` : ''}
            <button id="next-btn" onclick="goNext()">æ¬¡ã¸é€²ã‚€</button>
        `;
    }

    window.goNext = function() {
        const currentQ = questions[currentIdx];
        
        // å…¥åŠ›å€¤ã‚’è‡ªå‹•å›å
        document.querySelectorAll('#main-stage input').forEach(el => {
            allAnswers[el.id] = el.value;
        });
        const bmi = document.getElementById('bmi-val');
        if (bmi) allAnswers['bmi'] = bmi.innerText;

        // ãƒ‰ãƒ­ãƒƒãƒ—åˆ¤å®š
        const isDropped = document.getElementById('drop-zone').querySelector('.active-item');
        allAnswers[currentQ.id] = isDropped ? "ã¯ã„" : "ã„ã„ãˆ";

        currentIdx++;
        if (currentIdx < questions.length) {
            load();
        } else {
            // å®Œäº†ï¼šStreamlitã¸å…¨é€ä¿¡
            const url = new URL(window.location.href);
            Object.keys(allAnswers).forEach(key => url.searchParams.set(key, allAnswers[key]));
            alert("å…¨ã¦ã®å›ç­”ã‚’é€ä¿¡ã—ã¾ã™ã€‚");
            window.location.href = url.href; 
        }
    };

    // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ãƒ­ã‚¸ãƒƒã‚¯
    let active, isDragging = false;
    window.onStart = function(e) {
        isDragging = true;
        active = e.target;
        active.style.position = "absolute";
        const t = e.touches ? e.touches[0] : e;
        move(t);

        document.ontouchmove = document.onmousemove = (ev) => {
            if(!isDragging) return;
            move(ev.touches ? ev.touches[0] : ev);
        };

        document.ontouchend = document.onmouseup = () => {
            if(!isDragging) return;
            isDragging = false;
            const dz = document.getElementById('drop-zone').getBoundingClientRect();
            const it = active.getBoundingClientRect();

            if (it.left > dz.left && it.right < dz.right && it.top > dz.top && it.bottom < dz.bottom) {
                const zone = document.getElementById('drop-zone');
                zone.innerText = "";
                zone.appendChild(active);
                active.style.position = "static";
                document.getElementById('next-btn').style.display = "block";
            } else {
                active.style.position = "static"; // å¤±æ•—ã—ãŸã‚‰æˆ»ã™
            }
            document.ontouchmove = document.onmousemove = null;
        };
    };

    function move(t) {
        active.style.left = (t.clientX - 35) + 'px';
        active.style.top = (t.clientY - 35) + 'px';
    }

    window.judge = function() {
        const g = parseFloat(document.getElementById('grip')?.value);
        if (g) document.getElementById('dot-grip').className = "status-dot " + (g < 28 ? "bg-red" : "bg-blue");

        const h = parseFloat(document.getElementById('height')?.value) / 100;
        const w = parseFloat(document.getElementById('weight')?.value);
        if (h > 0 && w > 0) {
            const bmi = (w / (h * h)).toFixed(1);
            document.getElementById('bmi-val').innerText = bmi;
            document.getElementById('dot-bmi').className = "status-dot " + (bmi < 21.5 ? "bg-red" : "bg-blue");
        }
    }

    // åˆå›èµ·å‹•
    load();
</script>

</body>
</html>