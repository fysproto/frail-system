<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
/* ===============================
   アプリ全体固定（ドラッグ前提）
================================ */
html, body { 
    position: fixed;
    width: 100%;
    height: 100%;
    overflow: hidden;
    font-family: sans-serif;
    margin: 0;
    background: #f0f4f8;
    touch-action: none;   /* ← 基本は無効 */
}

#app { display: flex; flex-direction: column; height: 100%; }

header {
    height: 70px;
    background: #fff;
    text-align: center;
    border-bottom: 2px solid #dee2e6;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

/* メイン */
#main-stage {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

/* ドロップゾーン */
#drop-zone {
    width: 150px;
    height: 150px;
    border: 4px dashed #adb5bd;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #fff;
    color: #adb5bd;
}

.placed-seal {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    position: absolute;
}

/* 選択肢 */
#seals-container {
    height: 180px;
    background: #fff;
    border-top: 1px solid #dee2e6;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 10px;
}

.seal-row { display: flex; gap: 12px; justify-content: center; }
.seal {
    width: 68px;
    height: 68px;
    border-radius: 50%;
    background: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: bold;
}

/* 計測フォーム */
#input-form {
    display: none;
    width: 90%;
    background: white;
    padding: 20px;
    border-radius: 15px;
}

.input-group {
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.input-group input {
    width: 80px;
    padding: 8px;
    font-size: 1.2rem;
    text-align: right;
}

.status-dot {
    width: 25px;
    height: 25px;
    border-radius: 50%;
    background: #ddd;
}

/* 判定色 */
.bg-blue { background: #007bff !important; }
.bg-red { background: #dc3545 !important; }
.bg-yellow { background: #ffc107 !important; color: #000; }

/* 次へボタン
   ※ calc画面のみ操作可能にする */
#next-btn {
    display: none;
    margin-top: 15px;
    padding: 10px 40px;
    border-radius: 25px;
    border: none;
    background: #28a745;
    color: white;
    font-weight: bold;

    touch-action: manipulation;
    pointer-events: auto;
}
</style>
</head>

<!-- body の preventDefault は削除 -->
<body>
<div id="app">

<header>
    <div id="q-progress"></div>
    <div id="q-text"></div>
</header>

<div id="main-stage">

    <div id="drop-zone-wrap">
        <div id="drop-zone">ここにドロップ</div>
    </div>

    <div id="input-form">
        <div class="input-group">
            <span>握力 (kg)</span>
            <input type="number" id="grip" oninput="judgeGrip()">
            <div id="dot-grip" class="status-dot"></div>
        </div>

        <div class="input-group">
            <span>身長 (cm)</span>
            <input type="number" id="height" oninput="calcBMI()">
            <div></div>
        </div>

        <div class="input-group">
            <span>体重 (kg)</span>
            <input type="number" id="weight" oninput="calcBMI()">
            <div></div>
        </div>

        <div class="input-group" style="border-top:1px solid #eee;padding-top:10px;">
            <span>BMI</span>
            <span id="bmi-val">--</span>
            <div id="dot-bmi" class="status-dot"></div>
        </div>
    </div>

    <button id="next-btn" onclick="goNext()">次へ進む</button>
</div>

<div id="seals-container"></div>
</div>

<script>
/* ===============================
   設問定義（業者向け）
================================ */
const questions = [
    { id: 12, text: "Q12. 地域活動に参加していますか？", opts: ["週1以上","月1以上","年数回","以前は参加","参加せず"], type: "neutral" },
    { id: 7, text: "Q7. 歩く速度が遅くなりましたか？", opts: ["はい","いいえ"], type: "logic", red: "はい", blue: "いいえ" },
    { id: "calc", text: "身体計測（握力・BMI）", type: "calc" }
];

let currentIdx = 0;
const dropZone = document.getElementById('drop-zone');
const container = document.getElementById('seals-container');
const inputForm = document.getElementById('input-form');
const nextBtn = document.getElementById('next-btn');

function load() {
    const q = questions[currentIdx];
    document.getElementById('q-progress').innerText = `STEP ${currentIdx + 1} / ${questions.length}`;
    document.getElementById('q-text').innerText = q.text;
    nextBtn.style.display = "none";

    if (q.type === "calc") {
        document.body.style.touchAction = "auto";   // ★ ここが肝
        document.getElementById('drop-zone-wrap').style.display = "none";
        container.style.display = "none";
        inputForm.style.display = "block";
        nextBtn.style.display = "block";
    } else {
        document.body.style.touchAction = "none";
        document.getElementById('drop-zone-wrap').style.display = "block";
        container.style.display = "flex";
        inputForm.style.display = "none";
        renderSeals(q.opts);
        dropZone.innerHTML = "ここにドロップ";
    }
}

/* 以下、元ロジック完全維持 */
function renderSeals(opts) {
    container.innerHTML = "";
    const row1 = document.createElement('div'); row1.className = 'seal-row';
    const row2 = document.createElement('div'); row2.className = 'seal-row';
    opts.forEach((opt, i) => {
        const s = document.createElement('div');
        s.className = 'seal';
        s.innerText = opt;
        s.addEventListener('touchstart', onStart, { passive: false });
        (i < 3 ? row1 : row2).appendChild(s);
    });
    container.appendChild(row1);
    if (opts.length > 3) container.appendChild(row2);
}

let active = null;
function onStart(e) {
    active = e.target.cloneNode(true);
    document.body.appendChild(active);
    active.style.position = 'fixed';
    updatePos(e.touches[0]);
    document.ontouchmove = ev => { ev.preventDefault(); updatePos(ev.touches[0]); };
    document.ontouchend = ev => {
        const t = ev.changedTouches[0];
        const r = dropZone.getBoundingClientRect();
        if (t.clientX > r.left && t.clientX < r.right && t.clientY > r.top && t.clientY < r.bottom) {
            dropZone.innerHTML = `<div class="placed-seal bg-yellow">${active.innerText}</div>`;
            nextBtn.style.display = "block";
        }
        active.remove();
        document.ontouchmove = null;
    };
}

function updatePos(t) {
    active.style.left = (t.clientX - 34) + 'px';
    active.style.top = (t.clientY - 34) + 'px';
}

function judgeGrip() {
    const v = parseFloat(grip.value);
    dotGrip.className = "status-dot " + (v < 28 ? "bg-red" : "bg-blue");
}

function calcBMI() {
    const h = height.value / 100;
    const w = weight.value;
    if (h && w) {
        const bmi = (w / (h * h)).toFixed(1);
        bmiVal.innerText = bmi;
        dotBmi.className = "status-dot " + (bmi < 21.5 ? "bg-red" : "bg-blue");
    }
}

function goNext() {
    currentIdx++;
    if (currentIdx < questions.length) load();
    else alert("測定完了");
}

load();
</script>
</body>
</html>
